<!DOCTYPE html>
<html>
 <head>
   <title>Pie Chart</title>
    <script type="text/javascript" src="../../lib/d3/d3.js"></script> 
    <script type="text/javascript" src="../../lib/d3/d3.layout.js"></script> 

    <script type="text/javascript" src="../../src/dipsy.js"></script>

   <style type="text/css">

body {
 font: 10px sans-serif;
}

   </style>
 </head>
 <body>

     <p style="font-size:24pt;">Click on a pie</p>

     <div id="chart"></div>

    <script type="text/javascript">
        
    //setup svg canvas
    var svg = d3.select("#chart")
        .append("svg:svg")
            //.attr("width", "1000")
            //.attr("height", "700")
            .attr("width", "1200")
            .attr("height", "750")
            .attr("viewBox", "0 0 1000 700")
            .attr("preserveAspectRatio", "xMinYMin meet")
            .attr("id", "charts");
            //.on("click", clickypie)
    var bgrect = svg.append("svg:rect")
        .attr("width", "100%")
        .attr("height", "100%")
        .attr("stroke", "#000")
        .attr("stroke-width", 1)
        .attr("fill", "none")



    var labels = new dipsy.Pops(svg)
    labels.follow_mouse = true;



    function bakepie(classname, data, x, y, r)
    { 
        //color could be made a parameter
        var color = d3.scale.category10()
        var arc = d3.svg.arc().outerRadius(r)
        var donut = d3.layout.pie();

        var pie = d3.select("#charts")
            .append("svg:g")
                //.data([data.sort(d3.descending)])
                .data([data])
                .attr("class", classname);

        var arcs = pie.selectAll("g.arc")
           .data(donut)
         .enter().append("svg:g")
           .attr("class", "arc")
           .attr("transform", "translate(" + x + "," + y + ")");


        var paths = arcs.append("svg:path")
            .attr("fill", function(d, i) { return color(i); })
            .attr("fill-opacity", .6)
            .attr("d", arc)
            .attr("tooltip", function(d,i)
            {
            console.log("bbox");
                var bbox = this.getBBox();
                //console.log(bbox);
                //console.log(this.parentNode);
                //console.log(matrix);
            
                /*
                var p = svg.node().createSVGPoint();
                var matrix = this.getTransformToElement(this.nearestViewportElement);
                var cp = p.matrixTransform(matrix);
                console.log(p);
                console.log(matrix);
                svg.append("svg:circle")
                .attr("cx", cp.x)
                .attr("cy", cp.y)
                .attr("r", 10)
                .attr("stroke", "none")
                .attr("fill", "#ff0000")
                .attr("fill-opacity", .7);
                */

                var lp = place_label(this, d, r + 10, bbox);
                //var sp = lp.matrixTransform(matrix);
                //console.log(xy);
                //labels.add(this, d.value);
                var content_format = d3.format(".2r");
                var content = content_format(d.value);
                labels.add(this, content, lp, false);
               
            })
            .on("mouseover", function(d, i) 
            {
                d3.select(this)
                    .attr("fill-opacity", 1);
            })
            .on("mouseout", function(d, i) 
            {
                d3.select(this)
                    .attr("fill-opacity", .6);
            });


    }

    var place_label = function(element, d, r, bbox)
    {   
        //calculate the angle for the center of the arc
        var ao = -Math.PI / 2;                      //arc angle offset (default from d3)
        var aa = (d.startAngle + d.endAngle) / 2;   //center angle
        var tx = Math.cos(aa + ao);
        var ty = Math.sin(aa + ao);
        //scale by input radius
        tx *= r;
        ty *= r;
        //return [tx, ty];
        return make_point(element, [tx,ty]);
    }   

    var make_point = function(element, xy)
    {
        //var matrix1 = element.getCTM();
        //console.log(matrix1);
        //var matrix = element.getScreenCTM();
        var p = element.nearestViewportElement.createSVGPoint();
        var matrix = element.getTransformToElement(element.nearestViewportElement);
        console.log(matrix);
        p.x = xy[0];
        p.y = xy[1];
        var sp = p.matrixTransform(matrix);
        return sp;
    }

    


    for(var i = 0; i < 5; i++)
    {
        for(var j = 0; j < 3; j++)
        {
            var r = 50 + Math.random() * 50;
            var data = d3.range(7).map(Math.random);
            //var data = d3.range(7).map(function(d) { return 10;});
            bakepie("pie"+ (j*10+i), data,  100 + i*(200), 120 + j*(210), r);
        }
    }

    /*
    var data = d3.range(10).map(Math.random)
    bakepie("pie1", data, 100, 100, 100);
    data = d3.range(20).map(Math.random)
    bakepie("pie2", data, 200, 200, 150);
    data = d3.range(30).map(Math.random)
    bakepie("pie3", data, 300, 300, 200);
    */

/*
    count = 0
    function clickypie()
    {  
        count += 1;
        var xy = d3.svg.mouse(this);
        var r = 25 + Math.random() * 25;
        var data = d3.range(10).map(Math.random)
        bakepie("pie"+count, data, xy[0], xy[1], r);
    };
    */
   
   </script>
 </body>
</html>
